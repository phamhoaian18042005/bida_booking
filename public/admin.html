<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản trị - 71 Billiards</title>
    <!-- Icon FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #e2e8f0; margin: 0; }
        
        .admin-header { background-color: #1e293b; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .brand { font-size: 20px; font-weight: bold; color: #facc15; letter-spacing: 1px; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .logout-btn:hover { background: #dc2626; }

        .container { padding: 30px; max-width: 1400px; margin: 0 auto; }

        /* THỐNG KÊ CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1e293b; padding: 25px; border-radius: 12px; border-left: 5px solid #3b82f6; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-card h3 { margin: 0 0 5px 0; color: #94a3b8; font-size: 13px; text-transform: uppercase; }
        .stat-card p { margin: 0; font-size: 26px; font-weight: bold; color: white; }
        .stat-card i { font-size: 40px; opacity: 0.2; color: white; }
        .card-rev { border-color: #22c55e; } .card-rev p { color: #4ade80; }
        .card-cancel { border-color: #ef4444; }

        /* BẢNG DỮ LIỆU */
        .section-heading { border-left: 4px solid #facc15; padding-left: 10px; margin-top: 30px; margin-bottom: 15px; color: white; font-weight: bold; }
        .table-wrap { background: #1e293b; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; padding: 15px 20px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #475569; white-space: nowrap; }
        td { padding: 15px 20px; border-bottom: 1px solid #334155; font-size: 14px; vertical-align: middle; }
        tr:hover { background: #2a354b; }

        .month-table th { background: #0284c7; color: white; }
        .price-text { color: #22c55e; font-weight: bold; }

        /* BUTTONS & BADGES */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 90px; text-align: center;}
        .st-ok { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid #3b82f6; }
        .st-can { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; }
        .st-done { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid #22c55e; }

        .btn-act { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; color: white; margin-right: 5px; font-size: 12px; font-weight: bold;}
        .btn-cancel { background: #ef4444; } .btn-cancel:hover { background: #dc2626; }
        .btn-done { background: #22c55e; } .btn-done:hover { background: #16a34a; }

        /* SEARCH */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px; border-left: 4px solid #facc15; padding-left: 10px; }
        .search-box input { background: #334155; border: 1px solid #475569; color: white; padding: 8px 12px; border-radius: 4px; outline:none; }
        .search-box button { background: #3b82f6; border: none; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-left: 5px; }

        .pay-cash { color: #facc15; font-weight: bold; font-size: 12px; }
        .pay-online { color: #38bdf8; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

    <header class="admin-header">
        <div class="brand"><i class="fa-solid fa-crown"></i> 71 BILLIARDS ADMIN</div>
        <div>
            <span id="user-display" style="margin-right:15px">Admin</span>
            <button onclick="logout()" class="logout-btn">Đăng xuất</button>
        </div>
    </header>

    <div class="container">
        <!-- 1. STATS -->
        <div class="stats-grid">
            <div class="stat-card"><div><h3>Tổng đơn</h3><p id="st-total">0</p></div><i class="fa-solid fa-file-invoice" style="color: #60a5fa"></i></div>
            <div class="stat-card card-rev"><div><h3>Tổng doanh thu</h3><p id="st-revenue">0 ₫</p></div><i class="fa-solid fa-money-bill-wave" style="color: #22c55e"></i></div>
            <div class="stat-card card-cancel"><div><h3>Đơn hủy</h3><p id="st-cancel">0</p></div><i class="fa-solid fa-ban" style="color: #ef4444"></i></div>
        </div>

        <!-- 2. MONTHLY -->
        <h3 class="section-heading">DOANH THU THEO THÁNG</h3>
        <div class="table-wrap">
            <table class="month-table">
                <thead><tr><th>Năm</th><th>Tháng</th><th>Số đơn xong</th><th>Doanh Thu Tháng</th></tr></thead>
                <tbody id="month-list"><tr><td colspan="4" style="text-align:center">Đang tính...</td></tr></tbody>
            </table>
        </div>

        <!-- 3. BOOKINGS -->
        <div class="list-header">
            <h3 style="margin:0; font-size:18px;">DANH SÁCH CHI TIẾT</h3>
            <div class="search-box">
                <input type="text" id="search-inp" placeholder="Tìm tên khách...">
                <button onclick="executeSearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
                <button onclick="loadData()" style="background:#475569"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr><th>ID</th><th>Khách Hàng</th><th>Bàn</th><th>Giờ & Tiền</th><th>Thanh Toán</th><th>Trạng Thái</th><th>Hành Động</th></tr>
                </thead>
                <tbody id="main-list">
                    <tr><td colspan="7" style="text-align:center; padding: 20px;">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        // Check Login
        const userStr = localStorage.getItem('user_info') || localStorage.getItem('user');
        if (!userStr) window.location.href = 'login.html';
        
        function logout() { localStorage.removeItem('user_info'); window.location.href = 'login.html'; }

        async function loadData() {
            try {
                // Tải Booking
                const res = await fetch(`${API_URL}/admin/bookings`);
                if(!res.ok) throw new Error("Lỗi API");
                const data = await res.json();
                renderTable(data);

                // Tải Tháng
                const resM = await fetch(`${API_URL}/admin/revenue/monthly`);
                if(resM.ok) renderMonths(await resM.json());
                
            } catch(e) {
                console.error(e);
                document.getElementById('main-list').innerHTML = `<tr><td colspan="7" style="text-align:center; color:red">Lỗi tải dữ liệu. Hãy kiểm tra Server!</td></tr>`;
            }
        }

        // Render Table
        function renderTable(data) {
            const tbody = document.getElementById('main-list');
            tbody.innerHTML = '';
            const fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

            let count = data.length, revenue = 0, cancel = 0;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#aaa; padding:20px;">Không có dữ liệu</td></tr>';
            }

            data.forEach(item => {
                if(item.status === 'cancelled') cancel++;
                else revenue += Number(item.total_price || 0);

                let badge=`<span class="badge st-done">Hoàn thành</span>`;
                let btns = `<span style="color:#555">-</span>`;
                
                if(item.status === 'confirmed') {
                    badge = `<span class="badge st-ok">Đang đặt</span>`;
                    btns = `<button class="btn-act btn-cancel" onclick="updateStatus(${item.id}, 'cancelled')">Hủy</button>
                            <button class="btn-act btn-done" onclick="updateStatus(${item.id}, 'completed')">Xong</button>`;
                } else if(item.status === 'cancelled') {
                    badge = `<span class="badge st-can">Đã hủy</span>`;
                }

                // Giờ Việt Nam
                const optsTime = { hour:'2-digit', minute:'2-digit', timeZone: 'Asia/Ho_Chi_Minh' };
                const optsDate = { day:'2-digit', month:'2-digit', timeZone: 'Asia/Ho_Chi_Minh' };
                const timeStr = new Date(item.start_time).toLocaleTimeString('vi-VN', optsTime) + " - " + 
                                new Date(item.end_time).toLocaleTimeString('vi-VN', optsTime);
                const dateStr = new Date(item.start_time).toLocaleDateString('vi-VN', optsDate);

                // Thanh toán
                const pMethod = item.payment_method || 'Tiền mặt';
                let payHtml = pMethod.includes('Tiền mặt') 
                    ? `<span class="pay-cash"><i class="fa-solid fa-money-bill"></i> TM</span>` 
                    : `<span class="pay-online"><i class="fa-solid fa-globe"></i> Online</span>`;

                // Tên Khách
                const guestName = item.customer_name || item.username || "Khách vãng lai";

                tbody.innerHTML += `
                    <tr>
                        <td style="color:#777">#${item.id}</td>
                        <td style="font-weight:bold; color:#facc15">${guestName}</td>
                        <td>${item.table_name || '?'}</td>
                        <td><div class="price-text">${fmt.format(item.total_price)}</div><span style="font-size:11px;color:#888">${timeStr} (${dateStr})</span></td>
                        <td>${payHtml}</td>
                        <td>${badge}</td>
                        <td>${btns}</td>
                    </tr>
                `;
            });

            if(!document.getElementById('search-inp').value) {
                document.getElementById('st-total').innerText = count;
                document.getElementById('st-cancel').innerText = cancel;
                document.getElementById('st-revenue').innerText = fmt.format(revenue);
            }
        }

        // Render Months
        function renderMonths(data) {
            const box = document.getElementById('month-list');
            box.innerHTML = '';
            const fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
            if(!data.length) box.innerHTML = '<tr><td colspan="4" style="text-align:center">Chưa có</td></tr>';
            data.forEach(m => {
                box.innerHTML += `<tr>
                    <td style="font-weight:bold; color:white">${m.year}</td>
                    <td>Tháng ${m.month}</td>
                    <td>${m.total_orders} đơn</td>
                    <td style="color:#4ade80; font-weight:bold">${fmt.format(m.total_revenue)}</td>
                </tr>`;
            });
        }

        // Action
        async function updateStatus(id, status) {
            if(!confirm(status==='cancelled'?"Hủy đơn?":"Khách đã xong?")) return;
            try {
                await fetch(`${API_URL}/admin/status`, {
                    method:'PUT', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({id, status})
                });
                loadData();
            } catch(e){ alert("Lỗi"); }
        }

        // Search
        async function executeSearch() {
            const q = document.getElementById('search-inp').value;
            if(!q) return;
            const res = await fetch(`${API_URL}/admin/search?q=${q}`);
            const data = await res.json();
            renderTable(data);
        }

        loadData();
    </script>
</body>
</html>