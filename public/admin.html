<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị - 71 Billiards</title>
    <!-- Icon FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- GIAO DIỆN DARK MODE --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #e2e8f0; margin: 0; }
        .admin-header { background-color: #1e293b; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .brand { font-size: 20px; font-weight: bold; color: #facc15; letter-spacing: 1px; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .logout-btn:hover { background: #dc2626; }

        .container { padding: 30px; max-width: 1400px; margin: 0 auto; }

        /* THỐNG KÊ CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1e293b; padding: 25px; border-radius: 12px; border-left: 5px solid #3b82f6; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-card h3 { margin: 0 0 5px 0; color: #94a3b8; font-size: 13px; text-transform: uppercase; }
        .stat-card p { margin: 0; font-size: 26px; font-weight: bold; color: white; }
        .stat-card i { font-size: 40px; opacity: 0.2; color: white; }
        .card-rev { border-color: #22c55e; } .card-rev p { color: #4ade80; }
        .card-cancel { border-color: #ef4444; }

        /* STYLE CHO THANH TÌM KIẾM */
        .list-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 30px; margin-bottom: 15px;
            border-left: 4px solid #facc15; padding-left: 10px;
        }
        .section-heading { margin: 0; color: white; font-size: 18px; font-weight: bold; }
        
        .search-box { display: flex; gap: 8px; }
        .search-box input {
            background-color: #334155; border: 1px solid #475569; color: white;
            padding: 8px 15px; border-radius: 6px; outline: none; width: 250px;
        }
        .search-box input:focus { border-color: #facc15; }
        
        .btn-search { background-color: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-search:hover { background-color: #2563eb; }
        .btn-refresh { background-color: #475569; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .btn-refresh:hover { background-color: #64748b; }

        /* BẢNG DỮ LIỆU */
        .table-wrap { background: #1e293b; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; padding: 15px 20px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #475569; }
        td { padding: 15px 20px; border-bottom: 1px solid #334155; font-size: 14px; vertical-align: middle; }
        tr:hover { background: #2a354b; }

        .month-table th { background: #0284c7; color: white; }
        .price-text { color: #22c55e; font-weight: bold; }

        /* BUTTONS & BADGES */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 90px; text-align: center;}
        .st-ok { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid #3b82f6; }
        .st-can { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; }
        .st-done { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid #22c55e; }

        .btn-act { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; color: white; margin-right: 5px; font-size: 12px; font-weight: bold;}
        .btn-cancel { background: #ef4444; } .btn-cancel:hover { background: #dc2626; }
        .btn-done { background: #22c55e; } .btn-done:hover { background: #16a34a; }

        .pay-info { font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .pay-wait { color: #facc15; } 
        .pay-done { color: #38bdf8; } 
        .pay-cash-done { color: #4ade80; } 
        .pay-cancel { color: #64748b; text-decoration: line-through; }
    </style>
</head>
<body>

    <header class="admin-header">
        <div class="brand"><i class="fa-solid fa-crown"></i> 71 BILLIARDS ADMIN</div>
        <div>
            <span id="user-display" style="margin-right:15px">Hello, Admin</span>
            <button onclick="logout()" class="logout-btn">Đăng xuất</button>
        </div>
    </header>

    <div class="container">
        
        <!-- THỐNG KÊ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div><h3>Tổng đơn</h3><p id="st-total">0</p></div>
                <i class="fa-solid fa-list-check" style="color: #60a5fa"></i>
            </div>
            <div class="stat-card card-rev">
                <div><h3>Tổng doanh thu</h3><p id="st-revenue">0 ₫</p></div>
                <i class="fa-solid fa-money-bill-wave" style="color: #22c55e"></i>
            </div>
            <div class="stat-card card-cancel">
                <div><h3>Đơn hủy</h3><p id="st-cancel">0</p></div>
                <i class="fa-solid fa-ban" style="color: #ef4444"></i>
            </div>
        </div>

        <!-- DOANH THU THÁNG -->
        <h3 class="section-heading" style="border-left: 4px solid #facc15; padding-left: 10px; margin-bottom: 15px; color:white; font-size:18px; font-weight:bold;">DOANH THU THEO THÁNG</h3>
        <div class="table-wrap">
            <table class="month-table">
                <thead><tr><th>Năm</th><th>Tháng</th><th>Số đơn xong</th><th>Doanh Thu Tháng</th></tr></thead>
                <tbody id="month-list"><tr><td colspan="4" style="text-align:center">Đang tính...</td></tr></tbody>
            </table>
        </div>

        <!-- THANH TIÊU ĐỀ + TÌM KIẾM -->
        <div class="list-header">
            <h3 class="section-heading" style="border:none; padding:0; margin:0;">DANH SÁCH ĐƠN ĐẶT HÀNG</h3>
            
            <div class="search-box">
                <input type="text" id="search-inp" placeholder="Tìm tên khách..." onkeypress="if(event.key==='Enter') executeSearch()">
                <button class="btn-search" onclick="executeSearch()"><i class="fa-solid fa-magnifying-glass"></i> Tìm</button>
                <button class="btn-refresh" onclick="loadData()" title="Làm mới"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>

        <!-- DANH SÁCH CHI TIẾT -->
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Khách Hàng</th>
                        <th>Bàn Đặt</th>
                        <th>Giờ & Tiền</th>
                        <th>Thanh Toán</th>
                        <th>Trạng Thái</th>
                        <th>Hành Động</th>
                    </tr>
                </thead>
                <tbody id="main-list">
                    <tr><td colspan="7" style="text-align:center; padding: 20px;">Loading data...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <script>
        const API_URL = '/api';
        
        // CHECK QUYỀN
        const userStr = localStorage.getItem('user_info') || localStorage.getItem('user');
        if (!userStr) window.location.href = 'login.html';
        const user = JSON.parse(userStr);
        document.getElementById('user-display').innerText = "Xin chào, " + (user.username || 'Admin');

        function logout() { localStorage.removeItem('user_info'); window.location.href = 'login.html'; }

        // --- HÀM TẢI DỮ LIỆU ---
        async function loadData() {
            document.getElementById('search-inp').value = ''; // Clear search box
            
            try {
                const res = await fetch(`${API_URL}/admin/bookings`);
                const data = await res.json();
                renderTable(data); // Render danh sách

                const resM = await fetch(`${API_URL}/admin/revenue/monthly`);
                const months = await resM.json();
                renderMonths(months); // Render tháng

            } catch(e) { console.error(e); }
        }

        // --- HÀM TÌM KIẾM ---
        async function executeSearch() {
            const keyword = document.getElementById('search-inp').value.trim();
            if (!keyword) { alert("Vui lòng nhập tên khách!"); return; }

            try {
                const res = await fetch(`${API_URL}/admin/search?q=${keyword}`);
                const data = await res.json();
                if (data.length === 0) { alert("Không tìm thấy kết quả!"); } 
                else { renderTable(data); }
            } catch (err) { alert("Lỗi tìm kiếm"); }
        }

        // --- RENDER BẢNG CHÍNH (Đã Fix giờ VN + Thanh Toán) ---
        function renderTable(data) {
            const tbody = document.getElementById('main-list');
            tbody.innerHTML = '';

            let count = data.length, revenue = 0, cancel = 0;
            const fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 20px; color:#aaa;">Không có dữ liệu</td></tr>';
            }

            data.forEach(item => {
                // Tính toán
                if (item.status === 'cancelled') cancel++;
                else revenue += Number(item.total_price || 0);

                // Trạng thái đơn
                let badgeClass='st-done', badgeText='Hoàn thành', btns='<span style="color:#666">-</span>';
                if (item.status === 'confirmed') {
                    badgeClass = 'st-ok'; badgeText = 'Đã đặt';
                    btns = `<button class="btn-act btn-cancel" onclick="updateStatus(${item.id}, 'cancelled')">Hủy</button>
                            <button class="btn-act btn-done" onclick="updateStatus(${item.id}, 'completed')">Xong</button>`;
                } else if (item.status === 'cancelled') {
                    badgeClass = 'st-can'; badgeText = 'Đã hủy';
                }

                // Cột thanh toán
                const pMethod = item.payment_method || 'Tiền mặt';
                let payStatusHtml = '';
                if (item.status === 'cancelled') {
                    payStatusHtml = `<div class="pay-info pay-cancel"><i class="fa-solid fa-ban"></i> Đã hủy</div>`;
                } else if (pMethod.includes('Online') || pMethod.includes('Chuyển') || pMethod.includes('Ví')) {
                    payStatusHtml = `<div class="pay-info pay-done"><i class="fa-solid fa-circle-check"></i> Đã TT Online</div>`;
                } else {
                    if (item.status === 'completed') {
                        payStatusHtml = `<div class="pay-info pay-cash-done"><i class="fa-solid fa-sack-dollar"></i> Đã thu tiền mặt</div>`;
                    } else {
                        payStatusHtml = `<div class="pay-info pay-wait"><i class="fa-regular fa-clock"></i> Chờ thu tiền</div>`;
                    }
                }

                // --- SỬA GIỜ: Ép múi giờ Asia/Ho_Chi_Minh ---
                const timeOpts = { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Ho_Chi_Minh' };
                const dateOpts = { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'Asia/Ho_Chi_Minh' };

                const startStr = new Date(item.start_time).toLocaleTimeString('vi-VN', timeOpts);
                const endStr = new Date(item.end_time).toLocaleTimeString('vi-VN', timeOpts);
                const dateStr = new Date(item.start_time).toLocaleDateString('vi-VN', dateOpts);
                // ----------------------------------------------------

                tbody.innerHTML += `
                    <tr>
                        <td style="color:#888">#${item.id}</td>
                        <td class="highlight-text" style="color:#facc15; font-weight:bold">${item.customer_name || 'Khách'}</td>
                        <td style="color:white;">${item.table_name || '...'}</td>
                        <td class="price-text">${fmt.format(item.total_price)}<br><span style="font-size:11px;color:#94a3b8;font-weight:normal">${startStr} -> ${endStr}<br>${dateStr}</span></td>
                        <td>${payStatusHtml}</td>
                        <td><span class="badge ${badgeClass}">${badgeText}</span></td>
                        <td>${btns}</td>
                    </tr>
                `;
            });

            // Chỉ cập nhật thống kê khi KHÔNG phải là đang tìm kiếm
            if (document.getElementById('search-inp').value === '') {
                document.getElementById('st-total').innerText = count;
                document.getElementById('st-cancel').innerText = cancel;
                document.getElementById('st-revenue').innerText = fmt.format(revenue);
            }
        }

        // --- RENDER DOANH THU THÁNG ---
        function renderMonths(data) {
            const mBody = document.getElementById('month-list');
            mBody.innerHTML = '';
            const fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
            
            if(data.length === 0) { mBody.innerHTML = '<tr><td colspan="4" style="text-align:center">Chưa có dữ liệu</td></tr>'; return; }

            data.forEach(m => {
                mBody.innerHTML += `<tr>
                    <td style="color:#fff;font-weight:bold">${m.year}</td>
                    <td>Tháng ${m.month}</td>
                    <td>${m.total_orders} đơn</td>
                    <td style="color:#facc15; font-weight:bold">${fmt.format(m.total_revenue)}</td>
                </tr>`;
            });
        }

        // --- UPDATE ---
        async function updateStatus(id, status) {
            let msg = status === 'cancelled' ? "Xác nhận HỦY?" : "Xác nhận khách đã CHƠI XONG và THANH TOÁN?";
            if(!confirm(msg)) return;

            try {
                const res = await fetch(`${API_URL}/admin/status`, {
                    method: 'PUT', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({id, status})
                });
                if(res.ok) loadData(); 
            } catch(e) { alert("Lỗi kết nối server"); }
        }

        loadData();
    </script>
</body>
</html>