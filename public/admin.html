<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị - 71 Billiards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: #e2e8f0; margin: 0; }
        
        .admin-header { background-color: #1e293b; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .brand { font-size: 20px; font-weight: bold; color: #facc15; letter-spacing: 1px; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .logout-btn:hover { background: #dc2626; }

        .container { padding: 30px; max-width: 1400px; margin: 0 auto; }

        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1e293b; padding: 25px; border-radius: 12px; border-left: 5px solid #3b82f6; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-card h3 { margin: 0 0 5px 0; color: #94a3b8; font-size: 13px; text-transform: uppercase; }
        .stat-card p { margin: 0; font-size: 26px; font-weight: bold; color: white; }
        .stat-card i { font-size: 40px; opacity: 0.2; color: white; }
        .card-rev { border-color: #22c55e; } .card-rev p { color: #4ade80; }
        .card-cancel { border-color: #ef4444; }

        /* BẢNG DỮ LIỆU */
        .section-heading { border-left: 4px solid #facc15; padding-left: 10px; margin-top: 30px; margin-bottom: 15px; color: white; font-weight: bold; }
        .table-wrap { background: #1e293b; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; padding: 15px 20px; text-align: left; color: #94a3b8; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #475569; }
        td { padding: 15px 20px; border-bottom: 1px solid #334155; font-size: 14px; vertical-align: middle; }
        tr:hover { background: #2a354b; }

        .month-table th { background: #0284c7; color: white; }
        .price-text { color: #22c55e; font-weight: bold; }

        /* BUTTONS & BADGES */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 100px; text-align: center;}
        
        .st-ok { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid #3b82f6; } /* Confirmed */
        .st-can { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; } /* Cancelled */
        .st-pending { background: rgba(234, 179, 8, 0.2); color: #facc15; border: 1px solid #eab308; } /* Pending */
        .st-done { background: rgba(148, 163, 184, 0.2); color: #cbd5e1; border: 1px solid #94a3b8; } /* Completed */

        .btn-act { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; color: white; margin-right: 5px; font-size: 12px; font-weight: bold;}
        .btn-cancel { background: #ef4444; } .btn-cancel:hover { background: #dc2626; }
        .btn-done { background: #22c55e; } .btn-done:hover { background: #16a34a; }
        .btn-confirm { background: #0284c7; } .btn-confirm:hover { background: #0369a1; }

        /* THANH TOÁN */
        .pay-info { font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .pay-wait { color: #facc15; } 
        .pay-done { color: #38bdf8; } 
        .pay-cash-done { color: #4ade80; } 
        .pay-cancel { color: #64748b; text-decoration: line-through; }
        
        .search-box input { background: #334155; border: 1px solid #475569; color: white; padding: 8px; border-radius: 4px; }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
    </style>
</head>
<body>

    <header class="admin-header">
        <div class="brand"><i class="fa-solid fa-crown"></i> 71 BILLIARDS ADMIN</div>
        <div>
            <span id="user-display" style="margin-right:15px">Admin</span>
            <button onclick="logout()" class="logout-btn">Đăng xuất</button>
        </div>
    </header>

    <div class="container">
        
        <!-- THỐNG KÊ -->
        <div class="stats-grid">
            <div class="stat-card"><div><h3>Tổng đơn</h3><p id="st-total">0</p></div><i class="fa-solid fa-file-invoice" style="color:#60a5fa"></i></div>
            <div class="stat-card card-rev"><div><h3>Tổng doanh thu</h3><p id="st-revenue">0 ₫</p></div><i class="fa-solid fa-money-bill-wave" style="color:#22c55e"></i></div>
            <div class="stat-card card-cancel"><div><h3>Đơn hủy</h3><p id="st-cancel">0</p></div><i class="fa-solid fa-ban" style="color:#ef4444"></i></div>
        </div>

        <!-- DOANH THU THÁNG -->
        <h3 class="section-heading">DOANH THU THEO THÁNG</h3>
        <div class="table-wrap">
            <table class="month-table">
                <thead><tr><th>Năm</th><th>Tháng</th><th>Số đơn xong</th><th>Doanh Thu Tháng</th></tr></thead>
                <tbody id="month-list"><tr><td colspan="4" style="text-align:center">Loading...</td></tr></tbody>
            </table>
        </div>

        <!-- CHI TIẾT -->
        <div class="list-header">
            <h3 class="section-heading" style="margin:0; border:none; padding:0">DANH SÁCH CHI TIẾT</h3>
            <div class="search-box">
                <input type="text" id="search-inp" placeholder="Tìm tên khách..." onkeypress="if(event.key==='Enter') executeSearch()">
                <button onclick="executeSearch()" class="btn-act btn-done" style="margin:0"><i class="fa-solid fa-magnifying-glass"></i></button>
                <button onclick="loadData()" class="btn-act" style="background:#475569; margin:0"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>
        
        <div class="table-wrap" style="margin-top:15px">
            <table>
                <thead>
                    <tr><th>ID</th><th>Khách Hàng</th><th>Bàn & Chi nhánh</th><th>Giờ (Chuẩn)</th><th>Thanh Toán</th><th>Tiền</th><th>Trạng Thái</th><th>Hành Động</th></tr>
                </thead>
                <tbody id="main-list"><tr><td colspan="8" style="text-align:center; padding: 20px;">Loading data...</td></tr></tbody>
            </table>
        </div>

    </div>

    <script>
        const API_URL = '/api';
        const userStr = localStorage.getItem('user_info') || localStorage.getItem('user');
        if (!userStr) window.location.href = 'login.html';
        document.getElementById('user-display').innerText = "Hi, " + JSON.parse(userStr).username;
        function logout() { localStorage.removeItem('user_info'); window.location.href = 'login.html'; }

        // --- FIX LỖI GIỜ (Dùng raw UTC để khớp hiển thị khách hàng) ---
        function formatRawTime(isoString) {
            if(!isoString) return "";
            const d = new Date(isoString);
            const h = d.getUTCHours().toString().padStart(2, '0');
            const m = d.getUTCMinutes().toString().padStart(2, '0');
            const date = d.getUTCDate().toString().padStart(2, '0') + '/' + (d.getUTCMonth()+1).toString().padStart(2,'0');
            return `${h}:${m} (${date})`;
        }

        async function loadData() {
            try {
                const res = await fetch(`${API_URL}/admin/bookings`);
                renderTable(await res.json());
                const resM = await fetch(`${API_URL}/admin/revenue/monthly`);
                renderMonths(await resM.json());
            } catch(e) { console.error(e); }
        }

        function renderTable(data) {
            const tbody = document.getElementById('main-list');
            tbody.innerHTML = '';
            let count=0, revenue=0, cancel=0;
            const fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

            if (data.length === 0) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:#aaa; padding:20px;">Không có dữ liệu</td></tr>';

            data.forEach(item => {
                count++;
                if (item.status === 'cancelled') cancel++;
                else if (item.status === 'completed' || item.status === 'confirmed') revenue += Number(item.total_price || 0);

                // --- SỬA LOGIC HIỂN THỊ TRẠNG THÁI (FIX #1) ---
                let badge='', btns='-';
                if (item.status === 'confirmed') {
                    badge = `<span class="badge st-ok">Đã đặt</span>`;
                    btns = `<button class="btn-act btn-cancel" onclick="updateStatus(${item.id}, 'cancelled')">Hủy</button>
                            <button class="btn-act btn-done" onclick="updateStatus(${item.id}, 'completed')">Xong</button>`;
                } else if (item.status === 'pending') {
                    // ĐÂY LÀ CÁI BẠN ĐANG THIẾU
                    badge = `<span class="badge st-pending">⏳ Chờ TT</span>`;
                    btns = `<button class="btn-act btn-cancel" onclick="updateStatus(${item.id}, 'cancelled')">Hủy</button>
                            <button class="btn-act btn-confirm" onclick="updateStatus(${item.id}, 'confirmed')">Duyệt</button>`;
                } else if (item.status === 'cancelled') {
                    badge = `<span class="badge st-can">Đã hủy</span>`;
                } else {
                    badge = `<span class="badge st-done">Hoàn tất</span>`;
                }

                // --- THANH TOÁN ---
                const pMethod = item.payment_method || 'Tiền mặt';
                let payHtml = pMethod.includes('Tiền mặt') 
                    ? `<span class="pay-wait" style="color:#f59e0b">Tiền mặt</span>` 
                    : `<span class="pay-done" style="color:#38bdf8">Online/QR</span>`;

                if(item.status === 'completed' && pMethod.includes('Tiền mặt')) payHtml = `<span style="color:#4ade80">✅ Đã thu</span>`;
                if(item.status === 'confirmed' && !pMethod.includes('Tiền mặt')) payHtml = `<span style="color:#4ade80">✅ Đã bank</span>`;

                const timeStr = `${formatRawTime(item.start_time)} ➝ ${formatRawTime(item.end_time).split(' ')[0]}`;

                tbody.innerHTML += `
                    <tr>
                        <td style="color:#888">#${item.id}</td>
                        <td style="color:#facc15;font-weight:bold">${item.customer_name || 'Khách'}</td>
                        <td>${item.table_name}<br><small style="color:#888">CN ${item.branch_id || 1}</small></td>
                        <td style="font-size:13px">${timeStr}</td>
                        <td>${payHtml}</td>
                        <td class="price-text">${fmt.format(item.total_price)}</td>
                        <td>${badge}</td>
                        <td>${btns}</td>
                    </tr>
                `;
            });

            if(!document.getElementById('search-inp').value) {
                document.getElementById('st-total').innerText = count;
                document.getElementById('st-cancel').innerText = cancel;
                document.getElementById('st-revenue').innerText = fmt.format(revenue);
            }
        }

        function renderMonths(data) {
            const box = document.getElementById('month-list');
            box.innerHTML = '';
            const fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
            data.forEach(m => {
                box.innerHTML += `<tr><td style="color:white;font-weight:bold">${m.year}</td><td>Tháng ${m.month}</td><td>${m.total_orders} đơn</td><td style="color:#4ade80;font-weight:bold">${fmt.format(m.total_revenue)}</td></tr>`;
            });
        }

        async function updateStatus(id, status) {
            if(!confirm("Xác nhận thao tác?")) return;
            await fetch(`${API_URL}/admin/status`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id, status}) });
            loadData();
        }
        
        async function executeSearch() {
            const q = document.getElementById('search-inp').value;
            const res = await fetch(`${API_URL}/admin/search?q=${q}`);
            renderTable(await res.json());
        }

        loadData();
    </script>
</body>
</html>