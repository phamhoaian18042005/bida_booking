<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫∑t B√†n - 71 Billiards</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* CSS FORM G·ªåN G√ÄNG */
        .booking-container { max-width: 500px; margin: 50px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        
        /* CSS CHO MODAL THANH TO√ÅN (QR CODE) */
        .custom-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 25px; border-radius: 12px; width: 95%; max-width: 420px; text-align: center; position: relative; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-logo { font-size: 24px; font-weight: bold; margin-bottom: 15px; display: inline-block; padding: 5px 15px; background: black; color: white; border-radius: 4px; }
        
        .qr-frame {
            border: 2px solid #2ecc71; border-radius: 10px; padding: 15px; margin: 15px 0; background: #f0fff4;
        }
        .qr-img { width: 100%; max-width: 250px; display: block; margin: 0 auto; border-radius: 5px; }
        
        .btn-modal { width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-close { background: #888; margin-top: 10px; }
        
        /* B·∫£ng h√≥a ƒë∆°n nh·ªè */
        .mini-bill { text-align: left; font-size: 14px; color: #555; background: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px dashed #ddd; }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    </style>
</head>
<body>
    
    <div class="navbar">
        <div class="logo-text">71 BILLIARDS</div>
        <div><a href="index.html">Quay l·∫°i Trang ch·ªß</a></div>
    </div>

    <div class="booking-container">
        <h1>ƒê·∫∂T B√ÄN ONLINE</h1>
        <form id="booking-form">
            <div class="form-group">
                <label>H·ªç t√™n:</label>
                <input type="text" id="customer-name" placeholder="V√≠ d·ª•: Anh T√†i" required>
            </div>
            
            <div class="form-group">
                <label>Chi Nh√°nh:</label>
                <select id="branch-select" onchange="loadTables()"></select>
            </div>

            <div class="form-group">
                <label>B√†n:</label>
                <select id="table-select" required>
                    <option value="">-- ƒêang t·∫£i danh s√°ch... --</option>
                </select>
            </div>

            <!-- CH·ªåN GI·ªú -->
            <div class="form-group">
                <label>B·∫Øt ƒë·∫ßu:</label>
                <input type="datetime-local" id="start-time" required>
            </div>
            <div class="form-group">
                <label>K·∫øt th√∫c:</label>
                <input type="datetime-local" id="end-time" required>
            </div>

            <!-- CH·ªåN THANH TO√ÅN (CU·ªêI C√ôNG) -->
            <div class="form-group" style="background: #e3f2fd; padding: 10px; border-radius: 8px;">
                <label style="color:#0277bd">H√¨nh th·ª©c thanh to√°n:</label>
                <select id="payment-method">
                    <option value="Chuy·ªÉn kho·∫£n (QR)">Chuy·ªÉn kho·∫£n Ng√¢n h√†ng (QR Code)</option>
                    <option value="Ti·ªÅn m·∫∑t">Ti·ªÅn m·∫∑t t·∫°i qu·∫ßy (Tr·∫£ sau)</option>
                    <option value="V√≠ MoMo">V√≠ MoMo (B·∫£o tr√¨)</option>
                </select>
            </div>

            <button type="submit" class="btn" style="width: 100%; padding: 15px; font-size: 16px; font-weight: bold; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer;">
                X√ÅC NH·∫¨N ƒê·∫∂T B√ÄN
            </button>
        </form>
    </div>

    <!-- MODAL HI·ªÜN M√É QR (Ch·ªâ hi·ªán sau khi b·∫•m ƒë·∫∑t) -->
    <div id="payment-modal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-logo">71 BILLIARDS</div>
            <h3 id="modal-title" style="color: #2ecc71; margin: 10px 0;">ƒê·∫∂T B√ÄN TH√ÄNH C√îNG</h3>
            
            <!-- Khu v·ª±c hi·ªán th√¥ng tin h√≥a ƒë∆°n -->
            <div class="mini-bill" id="modal-bill"></div>

            <!-- Khu v·ª±c hi·ªán m√£ QR -->
            <div id="qr-container" style="display: none;" class="qr-frame">
                <img id="qr-image" src="" class="qr-img">
                <p style="margin: 10px 0 5px; color: #d35400; font-weight: bold;">Qu√©t m√£ ƒë·ªÉ thanh to√°n ngay</p>
                <p style="font-size: 12px; color: #666;"><i class="fa-solid fa-sync fa-spin"></i> H·ªá th·ªëng ƒëang ch·ªù ti·ªÅn v·ªÅ...</p>
                <p style="font-size: 11px; color: #888;">T·ª± ƒë·ªông x√°c nh·∫≠n sau 5 gi√¢y</p>
            </div>

            <button class="btn-modal" onclick="window.location.href='history.html'">XEM L·ªäCH S·ª¨</button>
        </div>
    </div>

    <!-- MODAL B√ÅO L·ªñI -->
    <div id="error-modal" class="custom-modal">
        <div class="modal-content" style="border-top: 5px solid red;">
            <h3 style="color:red">L·ªói</h3>
            <p id="error-msg">N·ªôi dung l·ªói...</p>
            <button class="btn-modal btn-close" onclick="document.getElementById('error-modal').style.display='none'">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH TH√îNG TIN CH√çNH ===
        const API_URL = '/api';
        const BANK_INFO = { bank: 'MB', account: '07118042005', name: 'PHAM HOAI AN' };
        
        let checkInterval = null; // Bi·∫øn ki·ªÉm tra ti·ªÅn

        // --- 1. LOGIC FORM ---
        const urlParams = new URLSearchParams(location.search);
        if(urlParams.get('branch')) document.getElementById('branch-select').value = urlParams.get('branch');
        
        // Load Danh S√°ch B√†n (T·ª± ƒë·ªông ch·∫°y)
        loadTables();
        function loadTables() {
            const bid = document.getElementById('branch-select').value || 1;
            const sel = document.getElementById('table-select');
            sel.innerHTML = '<option>‚è≥ ƒêang t·∫£i b√†n...</option>';
            
            fetch(`${API_URL}/tables?branch_id=${bid}`)
                .then(r => r.json())
                .then(data => {
                    sel.innerHTML = '<option value="">-- Ch·ªçn b√†n --</option>';
                    data.forEach(t => {
                        // T√≠nh nƒÉng hi·ªÉn th·ªã (B·∫≠n)
                        let note = t.is_busy > 0 ? " (üî¥ ƒêang b·∫≠n)" : "";
                        sel.innerHTML += `<option value="${t.id}" data-price="${t.price_per_hour}">${t.name} - ${new Intl.NumberFormat().format(t.price_per_hour)}ƒë${note}</option>`;
                    });
                    
                    const tid = urlParams.get('table_id');
                    if(tid) sel.value = tid;
                });
        }

        // --- 2. X·ª¨ L√ù N√öT ƒê·∫∂T (CLICK S·∫º KH√îNG B·ªä ƒê∆† N·ªÆA) ---
        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // L·∫•y d·ªØ li·ªáu
            const userStr = localStorage.getItem('user_info');
            if(!userStr) { alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!"); window.location.href='login.html'; return; }
            const user = JSON.parse(userStr);

            const nameVal = document.getElementById('customer-name').value;
            const tableVal = document.getElementById('table-select').value;
            const payMethod = document.getElementById('payment-method').value;
            
            if(payMethod.includes('MoMo')) { showError('V√≠ MoMo ƒëang b·∫£o tr√¨.'); return; }
            if(!tableVal) { showError('Vui l√≤ng ch·ªçn b√†n.'); return; }

            const start = new Date(document.getElementById('start-time').value);
            const end = new Date(document.getElementById('end-time').value);

            // Ki·ªÉm tra gi·ªù
            const now = new Date();
            // L·∫•y th·ªùi gian hi·ªán t·∫°i c·ªông th√™m 7 ti·∫øng (ƒë·ªÉ kh·ªõp m√∫i gi·ªù Server) - ƒê√£ fix an to√†n
            // Nh∆∞ng ƒë∆°n gi·∫£n nh·∫•t: So s√°nh v·ªõi ch√≠nh n√≥.
            if(end <= start) { showError('Gi·ªù K·∫øt th√∫c ph·∫£i SAU gi·ªù B·∫Øt ƒë·∫ßu'); return; }
            if(start < now) { showError('Vui l√≤ng ch·ªçn th·ªùi gian t∆∞∆°ng lai.'); return; }

            // T√≠nh ti·ªÅn
            const sel = document.getElementById('table-select');
            const price = parseFloat(sel.options[sel.selectedIndex].getAttribute('data-price')) || 0;
            const hours = (end - start) / 3600000;
            const total = Math.ceil(hours * price);

            try {
                // G·ª≠i l√™n Server
                const res = await fetch(`${API_URL}/booking`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: user.id, customer_name: nameVal, table_id: tableVal,
                        start_time: document.getElementById('start-time').value,
                        end_time: document.getElementById('end-time').value,
                        total_price: total, payment_method: payMethod
                    })
                });

                const result = await res.json();

                if (res.ok) {
                    // => TH√ÄNH C√îNG -> HI·ªÜN MODAL QR
                    showPaymentModal(nameVal, total, payMethod, result.bookingId);
                } else {
                    // => TH·∫§T B·∫†I
                    showError(result.message + (result.suggestion ? `<br>G·ª£i √Ω: ${new Date(result.suggestion).toLocaleTimeString('vi-VN')}` : ""));
                }

            } catch (err) { showError('L·ªói k·∫øt n·ªëi Server'); }
        });

        // --- 3. H√ÄM HI·ªÇN TH·ªä MODAL THANH TO√ÅN (X·ªäN X√í) ---
        function showPaymentModal(name, total, method, bookingId) {
            const modal = document.getElementById('payment-modal');
            const qrContainer = document.getElementById('qr-container');
            const fmt = new Intl.NumberFormat('vi-VN').format(total);
            
            // ƒêi·ªÅn th√¥ng tin h√≥a ƒë∆°n
            document.getElementById('modal-bill').innerHTML = `
                <div class="bill-row"><strong>Kh√°ch h√†ng:</strong> <span>${name}</span></div>
                <div class="bill-row"><strong>H√¨nh th·ª©c:</strong> <span style="color:#007bff; font-weight:bold">${method}</span></div>
                <div class="bill-row"><strong>T·ªïng c·ªông:</strong> <span style="color:red; font-size:16px; font-weight:bold">${fmt} ƒë</span></div>
            `;

            // Logic QR Code
            if (method.includes('Chuy·ªÉn kho·∫£n')) {
                qrContainer.style.display = 'block';
                // T·∫°o QR VietQR x·ªãn
                const content = `BIDA ${bookingId}`; // N·ªôi dung CK: BIDA + M√£
                const linkQR = `https://img.vietqr.io/image/${BANK_INFO.bank}-${BANK_INFO.account}-compact2.png?amount=${total}&addInfo=${content}&accountName=${encodeURIComponent(BANK_INFO.name)}`;
                
                document.getElementById('qr-image').src = linkQR;

                // T·ª± ƒë·ªông ki·ªÉm tra ti·ªÅn v·ªÅ
                startCheckPayment(bookingId);

            } else {
                qrContainer.style.display = 'none'; // ·∫®n QR n·∫øu ti·ªÅn m·∫∑t
            }

            modal.style.display = 'flex';
        }

        // --- 4. T·ª∞ ƒê·ªòNG CHECK TI·ªÄN ---
        function startCheckPayment(id) {
            if(checkInterval) clearInterval(checkInterval);
            checkInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_URL}/booking/status/${id}`);
                    const data = await res.json();
                    if(data.status === 'confirmed') {
                        clearInterval(checkInterval);
                        alert("‚úÖ TI·ªÄN ƒê√É V·ªÄ! C·∫£m ∆°n b·∫°n.");
                        window.location.href = "history.html";
                    }
                } catch(e){}
            }, 3000); // 3 gi√¢y h·ªèi 1 l·∫ßn
        }

        // --- 5. H√ÄM TI·ªÜN √çCH ---
        function showError(msg) {
            document.getElementById('error-msg').innerHTML = msg;
            document.getElementById('error-modal').style.display = 'flex';
        }
    </script>
</body>
</html>