<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>L·ªãch S·ª≠ - 71 Billiards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS G·ªëc Gi·ªØ Nguy√™n */
        body { background-color: #050505; color: #fff; min-height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', sans-serif; }
        .page-header { padding: 40px 20px; text-align: center; background: linear-gradient(to bottom, #111, #050505); border-bottom: 1px solid #333; }
        .page-header h1 { margin: 0; font-size: 28px; text-transform: uppercase; color: #facc15; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 15px; flex: 1; }
        .table-responsive { overflow-x: auto; background-color: #1e1e1e; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #2c2c2c; color: #ccc; padding: 15px; text-align: left; font-size:12px; white-space:nowrap; border-bottom: 2px solid #444; }
        td { padding: 15px; border-bottom: 1px solid #333; font-size: 14px; vertical-align: middle; }
        
        .status-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; white-space: nowrap; font-size: 11px;}
        .st-confirmed { color: #4ade80; border: 1px solid #22c55e; }
        .st-pending   { color: #facc15; border: 1px solid #eab308; }
        .st-cancelled { color: #f87171; border: 1px solid #ef4444; }
        .st-completed { color: #94a3b8; border: 1px solid #64748b; }
        
        .pay-cash { color: #facc15; font-weight: bold; font-size:12px; }
        .pay-online { color: #38bdf8; font-weight: bold; font-size:12px; }

        .btn-cancel { color: #f87171; border: 1px solid #ef4444; background:none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .back-btn { display: inline-block; margin-top: 20px; color: #888; text-decoration: none; }
        
        /* Modal */
        .custom-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;}
        .modal-content { background:#1e293b; border:1px solid #475569; padding:30px; border-radius:15px; text-align:center; color:white; width: 350px; }
    </style>
</head>
<body>
    <div class="header" style="background:#1e1e1e; padding:15px;">
        <nav class="navbar">
            <a href="index.html" style="color:white; margin-right:20px; text-decoration:none">TRANG CH·ª¶</a>
            <a href="booking.html" class="highlight" style="color:#facc15; font-weight:bold; text-decoration:none">ƒê·∫∂T L·ªäCH</a>
        </nav>
    </div>

    <div class="page-header">
        <h1>L·ªãch S·ª≠ ƒê·∫∑t B√†n</h1>
        <p>Xin ch√†o, <b id="user-display-name" style="color:white;">...</b></p>
    </div>

    <div class="container">
        <div class="table-responsive">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>#ID</th>
                        <th>Kh√°ch H√†ng</th>
                        <th>Chi Ti·∫øt B√†n</th>
                        <th>Th·ªùi Gian (Chu·∫©n)</th>
                        <th>Ti·ªÅn & Thanh To√°n</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr><td colspan="7" style="text-align:center; padding: 30px; color:#888">ƒêang t·∫£i...</td></tr>
                </tbody>
            </table>
        </div>
        <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i trang ch·ªß</a>
    </div>

    <!-- MODAL -->
    <div id="confirm-modal" class="custom-modal">
        <div class="modal-content">
            <h3 style="margin-bottom:10px; color:#facc15">X√°c nh·∫≠n h·ªßy?</h3>
            <p style="font-size:13px; color:#ccc">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                <button onclick="document.getElementById('confirm-modal').style.display='none'" style="padding:8px 16px;">Gi·ªØ l·∫°i</button>
                <button onclick="executeCancel()" style="padding:8px 16px; background:#ef4444; border:none; color:white;">ƒê·ªìng √Ω</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let deleteIdTemp = null;

        const userStr = localStorage.getItem('user_info') || localStorage.getItem('user');
        if (!userStr) window.location.href = 'login.html';
        const currentUser = JSON.parse(userStr);
        document.getElementById('user-display-name').innerText = currentUser.username;

        const fmtMoney = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

        // --- H√ÄM X·ª¨ L√ù GI·ªú (RAW UTC - KH√îNG B·ªä C·ªòNG GI·ªú) ---
        // Server l∆∞u: "2026-01-18T13:00:00.000Z" (D√π chu·ªói c√≥ ch·ªØ Z, nh∆∞ng n·ªôi dung l√† 13:00 ƒë√∫ng √Ω b·∫°n nh·∫≠p)
        // Ta s·∫Ω c·∫Øt chu·ªói ƒë·ªÉ l·∫•y ƒë√∫ng 13:00, kh√¥ng cho n√≥ t·ª± convert.
        function getRawTime(isoString) {
            if(!isoString) return "";
            const d = new Date(isoString);
            // L·∫•y gi·ªù UTC g·ªëc (13:00) thay v√¨ gi·ªù local (20:00)
            const h = d.getUTCHours().toString().padStart(2, '0');
            const m = d.getUTCMinutes().toString().padStart(2, '0');
            return `${h}:${m}`;
        }
        
        function getRawDate(isoString) {
            if(!isoString) return "";
            const d = new Date(isoString);
            const D = d.getUTCDate().toString().padStart(2, '0');
            const M = (d.getUTCMonth()+1).toString().padStart(2, '0');
            const Y = d.getUTCFullYear();
            return `${D}/${M}/${Y}`;
        }

        fetch(`${API_URL}/history/${currentUser.id}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = ''; 

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 30px; color:#888">Ch∆∞a c√≥ d·ªØ li·ªáu.</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    // Logic N√∫t H·ªßy
                    let statusHtml='', actionHtml='-';
                    
                    if(item.status === 'confirmed') statusHtml = `<span class="status-badge st-confirmed">‚úÖ ƒê√É ƒê·∫∂T</span>`;
                    else if(item.status === 'pending') {
                         statusHtml = `<span class="status-badge st-pending">‚åõ CH·ªú TT</span>`;
                         actionHtml = `<button class="btn-cancel" onclick="askCancel(${item.id})">H·ªßy</button>`;
                    }
                    else if(item.status === 'cancelled') statusHtml = `<span class="status-badge st-cancelled">‚ùå ƒê√É H·ª¶Y</span>`;
                    else statusHtml = `<span class="status-badge st-completed">üèÅ HO√ÄN T·∫§T</span>`;

                    // Thanh to√°n
                    const pMethod = item.payment_method || 'Ti·ªÅn m·∫∑t';
                    const payHtml = pMethod.includes('Ti·ªÅn m·∫∑t') 
                        ? `<span class="pay-cash">üíµ Ti·ªÅn m·∫∑t</span>` 
                        : `<span class="pay-online">üí≥ Chuy·ªÉn kho·∫£n</span>`;

                    tbody.innerHTML += `
                        <tr>
                            <td><span style="color:#666">#${item.id}</span></td>
                            <td><b>${item.customer_name || currentUser.username}</b></td>
                            <td>
                                <strong style="color:#facc15">${item.table_name || '...'}</strong>
                                <br><small style="color:#888">CN ${item.branch_id || 1}</small>
                            </td>
                            <td>
                                <!-- S·ª¨ D·ª§NG H√ÄM M·ªöI (Raw Time) -->
                                <b>${getRawTime(item.start_time)} - ${getRawTime(item.end_time)}</b>
                                <br><small style="color:#777">${getRawDate(item.start_time)}</small>
                            </td>
                            <td>
                                <div style="color:#4ade80;font-weight:bold">${fmtMoney.format(item.total_price)}</div>
                                <div>${payHtml}</div>
                            </td>
                            <td>${statusHtml}</td>
                            <td style="text-align:center">${actionHtml}</td>
                        </tr>
                    `;
                });
            });

        function askCancel(id) { deleteIdTemp = id; document.getElementById('confirm-modal').style.display='flex'; }
        async function executeCancel() {
            if(!deleteIdTemp) return;
            await fetch(`${API_URL}/booking/cancel`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({booking_id: deleteIdTemp})
            });
            location.reload();
        }
    </script>
</body>
</html>