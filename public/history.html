<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch S·ª≠ - 71 Billiards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        body { background-color: #050505; color: #fff; min-height: 100vh; display: flex; flex-direction: column; font-family: sans-serif;}
        
        .page-header {
            padding: 40px 20px; text-align: center;
            background: linear-gradient(to bottom, #111, #050505); border-bottom: 1px solid #333;
        }
        .page-header h1 { margin: 0; font-size: 28px; text-transform: uppercase; letter-spacing: 2px; }

        .container { max-width: 1200px; /* TƒÉng chi·ªÅu r·ªông ƒë·ªÉ ch·ª©a ƒë·ªß c·ªôt */ margin: 30px auto; padding: 0 15px; flex: 1; }

        .table-responsive { overflow-x: auto; }
        table {
            width: 100%; border-collapse: collapse; background-color: #111;
            border-radius: 8px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        th { background-color: #1a1a1a; color: #ccc; font-size: 12px; text-transform: uppercase; padding: 15px; text-align: left; border-bottom: 2px solid #333; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #222; color: #eee; font-size: 14px; vertical-align: middle; }
        tr:hover { background-color: #1f1f1f; transition: 0.3s; }

        /* Badge Styles */
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: inline-block; white-space: nowrap;}
        .st-confirmed { border: 1px solid #2ecc71; color: #2ecc71; }
        .st-cancelled { border: 1px solid #e74c3c; color: #e74c3c; }
        .st-completed { border: 1px solid #aaa; color: #aaa; }

        .pay-tag { font-size: 11px; padding: 4px 8px; border-radius: 4px; display: inline-block; font-weight: bold; white-space: nowrap; }
        .pay-cash { background-color: #f39c12; color: black; }
        .pay-online { background-color: #0ea5e9; color: white; }

        .btn-cancel { background-color: transparent; color: #e74c3c; border: 1px solid #e74c3c; padding: 6px 12px; font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .btn-cancel:hover { background-color: #e74c3c; color: white; }
        .btn-cancel.disabled { border-color: #444; color: #555; cursor: not-allowed; background: transparent; }

        .back-btn { display: inline-block; margin-top: 20px; color: #888; text-decoration: none; }

        /* Modal */
        .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background-color: #111; color: white; border: 1px solid #444; padding: 30px; border-radius: 12px; width: 300px; text-align: center; }
        .modal-logo { font-size: 20px; font-weight: bold; margin-bottom: 15px; display: inline-block; padding: 5px 15px; background: #fff; color: #000; letter-spacing: 2px; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-confirm { background: #e74c3c; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; }
        .btn-close { background: #555; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    
    <div class="header" style="background-color: #111; padding: 10px;">
        <nav class="navbar">
            <a href="index.html">TRANG CH·ª¶</a>
            <a href="history.html" class="active" style="color: #f39c12;">L·ªäCH S·ª¨</a>
            <a href="booking.html" class="highlight">ƒê·∫∂T L·ªäCH</a>
        </nav>
    </div>

    <div class="page-header">
        <h1>L·ªãch S·ª≠ ƒê·∫∑t B√†n</h1>
        <p>Qu·∫£n l√Ω c√°c cu·ªôc h·∫πn c·ªßa <b id="user-display-name">...</b></p>
    </div>

    <div class="container">
        <div class="table-responsive">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>#ID</th>
                        <!-- 1. TH√äM C·ªòT NG∆Ø·ªúI ƒê·∫∂T -->
                        <th>Ng∆∞·ªùi ƒë·∫∑t</th> 
                        <th>Chi ti·∫øt b√†n</th>
                        <th>Ng√†y & Gi·ªù (Chu·∫©n)</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Thanh to√°n</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr><td colspan="8" style="text-align:center; padding: 30px;">ƒêang t·∫£i...</td></tr>
                </tbody>
            </table>
        </div>
        <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i trang ch·ªß</a>
    </div>

    <!-- MODAL CONFIRM -->
    <div id="confirm-modal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-logo">71 BILLIARDS</div>
            <h3 style="margin-bottom: 10px;">X√°c nh·∫≠n h·ªßy ƒë·∫∑t b√†n?</h3>
            <p style="color: #bbb; font-size: 14px;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            <div class="btn-group">
                <button class="btn-close" onclick="closeConfirmModal()">Gi·ªØ l·∫°i</button>
                <button class="btn-confirm" onclick="executeCancel()">ƒê·ªìng √Ω H·ªßy</button>
            </div>
        </div>
    </div>

    <footer id="footer" class="footer-design"></footer>

   <script>
        const API_URL = '/api';

        // Check Login
        const userStr = localStorage.getItem('user_info') || localStorage.getItem('user');
        if (!userStr) window.location.href = 'login.html';
        
        const currentUser = JSON.parse(userStr);
        document.getElementById('user-display-name').innerText = currentUser.username || currentUser.full_name;

        // --- H√ÄM FIX L·ªñI GI·ªú (FINAL) ---
        // Thu·∫≠t to√°n: Bi·∫øn gi·ªù Server th√†nh gi·ªù UTC sau ƒë√≥ c·ªông 7 ti·∫øng th·ªß c√¥ng
        function toVietnamTime(dateString) {
            const date = new Date(dateString);
            // C·ªông 7 ti·∫øng (7 * 60 ph√∫t * 60 gi√¢y * 1000 mili gi√¢y)
            // (N·∫øu server ƒë√£ l∆∞u UTC th√¨ c√°i n√†y s·∫Ω √©p v·ªÅ ƒë√∫ng gi·ªù VN)
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const vnDate = new Date(date.getTime() + userTimezoneOffset + (7 * 3600000)); 
            return vnDate;
        }

        function formatTime(dateString) {
            const vnDate = toVietnamTime(dateString);
            return vnDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function formatDate(dateString) {
            const vnDate = toVietnamTime(dateString);
            return vnDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        }

        // --- LOAD D·ªÆ LI·ªÜU ---
        fetch(`${API_URL}/history/${currentUser.id}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = ''; 

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 30px;">B·∫°n ch∆∞a ƒë·∫∑t b√†n n√†o.</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    // Logic T√≠nh n√∫t H·ªßy
                    // L∆∞u √Ω: T√≠nh logic th√¨ ph·∫£i d√πng new Date(item.start_time) g·ªëc c·ªßa h·ªá th·ªëng ƒë·ªÉ so s√°nh cho chu·∫©n
                    const startReal = new Date(item.start_time);
                    const now = new Date();
                    // Render (UTC) v√† M√°y b·∫°n (VN) l·ªách nhau, c·∫ßn fix logic so s√°nh:
                    // ƒê∆°n gi·∫£n nh·∫•t: L·∫•y start time + 7 ti·∫øng so v·ªõi Now VN
                    const startVN = toVietnamTime(item.start_time); 
                    
                    const minutesLeft = (startReal - now) / 60000; // T√≠nh theo gi·ªù g·ªëc server

                    let statusBadge = '', actionButton = '-';
                    
                    if (item.status === 'confirmed') {
                        statusBadge = `<span class="status-badge st-confirmed">‚úÖ ƒê√£ ƒê·∫∑t (Xong)</span>`;
                    } 
                    else if (item.status === 'pending') {
                        statusBadge = `<span class="status-badge" style="background:#fff3cd; color:#d35400; border:1px solid #ffecb5">‚åõ Ch·ªù thanh to√°n</span>`;
                        actionButton = `<button class="btn-cancel" onclick="openConfirmModal(${item.id})">H·ªßy ƒë∆°n</button>`;
                    } 
                    else if (item.status === 'cancelled') {
                        statusBadge = `<span class="status-badge st-cancelled">‚ùå ƒê√£ h·ªßy</span>`;
                    } 
                    else {
                        statusBadge = `<span class="status-badge st-completed">üèÅ Ho√†n t·∫•t</span>`;
                    }

                    // Thanh to√°n hi·ªÉn th·ªã
                    let pMethod = item.payment_method || 'Ti·ªÅn m·∫∑t';
                    let payTagHtml = pMethod.includes('Ti·ªÅn m·∫∑t') 
                        ? `<span class="pay-tag pay-cash">Ti·ªÅn m·∫∑t</span>` 
                        : `<span class="pay-tag pay-online">Chuy·ªÉn kho·∫£n</span>`;

                    const branchInfo = `CN ${item.branch_id || '1'}`;

                    tbody.innerHTML += `
                        <tr>
                            <td><b style="color:#666">#${item.id}</b></td>
                            <td>
                                <strong style="color:#facc15">${item.table_name}</strong><br>
                                <span style="font-size:11px; color:#aaa;">${branchInfo}</span>
                            </td>
                            <td>
                                <b>${formatTime(item.start_time)}</b> <span style="font-size:11px">ƒë·∫øn</span> <b>${formatTime(item.end_time)}</b>
                                <br><span style="font-size:11px; color:#888">${formatDate(item.start_time)}</span>
                            </td>
                            <td>
                                <div style="font-weight:bold; color:#4ade80">${formatCurrency(item.total_price)}</div>
                                <div style="font-size:10px">${payTagHtml}</div>
                            </td>
                            <td>${statusBadge}</td>
                            <td style="text-align:center;">${actionButton}</td>
                        </tr>
                    `;
                });
            });

        // Logic Modal H·ªßy (Gi·ªØ nguy√™n)
        let deleteIdTemp = null;
        function openConfirmModal(id) { deleteIdTemp = id; document.getElementById('confirm-modal').style.display = 'flex'; }
        function closeConfirmModal() { deleteIdTemp = null; document.getElementById('confirm-modal').style.display = 'none'; }
        async function executeCancel() {
            if (!deleteIdTemp) return;
            await fetch(`${API_URL}/booking/cancel`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ booking_id: deleteIdTemp })
            });
            location.reload();
        }
    </script>
</body>
</html> 