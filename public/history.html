<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Sử - 71 Billiards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        body { background-color: #050505; color: #fff; min-height: 100vh; display: flex; flex-direction: column; font-family: sans-serif;}
        
        .page-header {
            padding: 40px 20px; text-align: center;
            background: linear-gradient(to bottom, #111, #050505); border-bottom: 1px solid #333;
        }
        .page-header h1 { margin: 0; font-size: 28px; text-transform: uppercase; letter-spacing: 2px; }

        .container { max-width: 1200px; /* Tăng chiều rộng để chứa đủ cột */ margin: 30px auto; padding: 0 15px; flex: 1; }

        .table-responsive { overflow-x: auto; }
        table {
            width: 100%; border-collapse: collapse; background-color: #111;
            border-radius: 8px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        th { background-color: #1a1a1a; color: #ccc; font-size: 12px; text-transform: uppercase; padding: 15px; text-align: left; border-bottom: 2px solid #333; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #222; color: #eee; font-size: 14px; vertical-align: middle; }
        tr:hover { background-color: #1f1f1f; transition: 0.3s; }

        /* Badge Styles */
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: inline-block; white-space: nowrap;}
        .st-confirmed { border: 1px solid #2ecc71; color: #2ecc71; }
        .st-cancelled { border: 1px solid #e74c3c; color: #e74c3c; }
        .st-completed { border: 1px solid #aaa; color: #aaa; }

        .pay-tag { font-size: 11px; padding: 4px 8px; border-radius: 4px; display: inline-block; font-weight: bold; white-space: nowrap; }
        .pay-cash { background-color: #f39c12; color: black; }
        .pay-online { background-color: #0ea5e9; color: white; }

        .btn-cancel { background-color: transparent; color: #e74c3c; border: 1px solid #e74c3c; padding: 6px 12px; font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
        .btn-cancel:hover { background-color: #e74c3c; color: white; }
        .btn-cancel.disabled { border-color: #444; color: #555; cursor: not-allowed; background: transparent; }

        .back-btn { display: inline-block; margin-top: 20px; color: #888; text-decoration: none; }

        /* Modal */
        .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background-color: #111; color: white; border: 1px solid #444; padding: 30px; border-radius: 12px; width: 300px; text-align: center; }
        .modal-logo { font-size: 20px; font-weight: bold; margin-bottom: 15px; display: inline-block; padding: 5px 15px; background: #fff; color: #000; letter-spacing: 2px; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-confirm { background: #e74c3c; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; }
        .btn-close { background: #555; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    
    <div class="header" style="background-color: #111; padding: 10px;">
        <nav class="navbar">
            <a href="index.html">TRANG CHỦ</a>
            <a href="history.html" class="active" style="color: #f39c12;">LỊCH SỬ</a>
            <a href="booking.html" class="highlight">ĐẶT LỊCH</a>
        </nav>
    </div>

    <div class="page-header">
        <h1>Lịch Sử Đặt Bàn</h1>
        <p>Quản lý các cuộc hẹn của <b id="user-display-name">...</b></p>
    </div>

    <div class="container">
        <div class="table-responsive">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>#ID</th>
                        <!-- 1. THÊM CỘT NGƯỜI ĐẶT -->
                        <th>Người đặt</th> 
                        <th>Chi tiết bàn</th>
                        <th>Ngày & Giờ (Chuẩn)</th>
                        <th>Tổng tiền</th>
                        <th>Thanh toán</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr><td colspan="8" style="text-align:center; padding: 30px;">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
        <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Quay lại trang chủ</a>
    </div>

    <!-- MODAL CONFIRM -->
    <div id="confirm-modal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-logo">71 BILLIARDS</div>
            <h3 style="margin-bottom: 10px;">Xác nhận hủy đặt bàn?</h3>
            <p style="color: #bbb; font-size: 14px;">Hành động này không thể hoàn tác.</p>
            <div class="btn-group">
                <button class="btn-close" onclick="closeConfirmModal()">Giữ lại</button>
                <button class="btn-confirm" onclick="executeCancel()">Đồng ý Hủy</button>
            </div>
        </div>
    </div>

    <footer id="footer" class="footer-design"></footer>

    <script>
        const API_URL = '/api';
        let deleteIdTemp = null;

        // Check Login
        const userStr = localStorage.getItem('user_info') || localStorage.getItem('user');
        if (!userStr) window.location.href = 'login.html';
        
        const currentUser = JSON.parse(userStr);
        const userId = currentUser.id;
        document.getElementById('user-display-name').innerText = currentUser.username || currentUser.full_name;

        // --- FIX LỖI GIỜ (Dùng múi giờ UTC để giữ nguyên số trong DB) ---
        function formatTimeVN(dateString) {
            return new Date(dateString).toLocaleTimeString('vi-VN', { 
                hour: '2-digit', minute: '2-digit', 
                timeZone: 'UTC' // Quan trọng: UTC giữ nguyên giờ bạn đã nhập, không cộng thêm
            });
        }
        function formatDateVN(dateString) {
            return new Date(dateString).toLocaleDateString('vi-VN', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                timeZone: 'UTC'
            });
        }
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        }

        // --- GỌI API ---
        fetch(`${API_URL}/history/${userId}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = ''; 

                if (data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 30px;">Bạn chưa đặt bàn nào.</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    const start = new Date(item.start_time);
                    const now = new Date();
                    // Lưu ý: So sánh thì vẫn phải dùng Time thật để check quá hạn
                    // Nhưng hiển thị thì dùng hàm format UTC ở trên
                    const minutesLeft = (start - now) / 60000;

                    let statusBadge = '', actionButton = '';
                    if (item.status === 'confirmed') {
                        statusBadge = `<span class="status-badge st-confirmed">Đã đặt</span>`;
                        
                        // Check Logic Hủy
                        // +420 phút là bù trừ lệch múi giờ (7 tiếng) nếu cần thiết để tính time thực
                        // Ở đây logic đơn giản cứ để nút hiện nếu status là confirmed
                        if (item.status === 'confirmed') {
                            actionButton = `<button class="btn-cancel" onclick="openConfirmModal(${item.id})">Hủy đơn</button>`;
                        } else {
                            actionButton = `<span style="color:#555">-</span>`;
                        }
                    } else if (item.status === 'cancelled') {
                        statusBadge = `<span class="status-badge st-cancelled">Đã hủy</span>`;
                        actionButton = '-';
                    } else {
                        statusBadge = `<span class="status-badge st-completed">Hoàn tất</span>`;
                        actionButton = '-';
                    }

                    // 2. TÊN KHÁCH (Ưu tiên tên Form nhập -> Tên User)
                    const nameShow = item.customer_name || currentUser.username || "Khách";

                    // 3. THANH TOÁN
                    const pMethod = item.payment_method || 'Tiền mặt'; 
                    let payHtml = '';
                    if (pMethod.includes('Tiền mặt')) {
                        payHtml = `<span class="pay-tag pay-cash"><i class="fa-solid fa-money-bill"></i> Tiền mặt</span>`;
                    } else {
                        payHtml = `<span class="pay-tag pay-online"><i class="fa-solid fa-globe"></i> ${pMethod}</span>`;
                    }

                    const branchName = item.branch_id ? `CN ${item.branch_id}` : '';

                    tbody.innerHTML += `
                        <tr>
                            <td>#${item.id}</td>
                            <!-- Cột NGƯỜI ĐẶT -->
                            <td style="color:#facc15; font-weight:bold">${nameShow}</td>
                            
                            <td>
                                <b>${item.table_name || '...'}</b><br>
                                <span style="font-size:11px;color:#888;">${branchName}</span>
                            </td>
                            <td>
                                <b>${formatTimeVN(item.start_time)} - ${formatTimeVN(item.end_time)}</b><br>
                                <span style="font-size:11px; color:#aaa">${formatDateVN(item.start_time)}</span>
                            </td>
                            <td style="font-weight:bold; color:#4ade80;">${formatCurrency(item.total_price)}</td>
                            <td>${payHtml}</td>
                            <td>${statusBadge}</td>
                            <td style="text-align:center;">${actionButton}</td>
                        </tr>
                    `;
                });
            })
            .catch(err => console.error(err));

        function openConfirmModal(id) { deleteIdTemp = id; document.getElementById('confirm-modal').style.display = 'flex'; }
        function closeConfirmModal() { deleteIdTemp = null; document.getElementById('confirm-modal').style.display = 'none'; }

        async function executeCancel() {
            if (!deleteIdTemp) return;
            try {
                const res = await fetch(`${API_URL}/booking/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ booking_id: deleteIdTemp })
                });
                if (res.ok) { location.reload(); }
            } catch (err) { alert("Lỗi mạng"); }
        }
    </script>
</body>
</html> 