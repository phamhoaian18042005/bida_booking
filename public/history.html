<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch S·ª≠ - 71 Billiards</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        body { background-color: #050505; color: #fff; min-height: 100vh; display: flex; flex-direction: column; font-family: sans-serif; }
        
        .page-header {
            padding: 40px 20px; text-align: center;
            background: linear-gradient(to bottom, #111, #050505); border-bottom: 1px solid #333;
        }
        .page-header h1 { margin: 0; font-size: 28px; text-transform: uppercase; letter-spacing: 2px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 15px; flex: 1; }
        .table-responsive { overflow-x: auto; }
        table {
            width: 100%; border-collapse: collapse; background-color: #111;
            border-radius: 8px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        th { background-color: #1a1a1a; color: #ccc; font-size: 12px; padding: 15px; text-align: left; border-bottom: 2px solid #333; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #222; color: #eee; font-size: 14px; vertical-align: middle; }
        
        /* TR·∫†NG TH√ÅI (ƒê√£ th√™m Pending) */
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: inline-block; white-space: nowrap; }
        .st-confirmed { border: 1px solid #2ecc71; color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
        .st-cancelled { border: 1px solid #e74c3c; color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        .st-pending   { border: 1px solid #f1c40f; color: #f1c40f; background: rgba(241, 196, 15, 0.1); }
        .st-completed { border: 1px solid #aaa; color: #aaa; }

        .pay-tag { font-size: 11px; padding: 3px 8px; border-radius: 4px; margin-top: 5px; display: inline-block; }
        .pay-online { background-color: #0ea5e9; color: white; }
        .pay-cash { background-color: #f59e0b; color: black; }
        
        .back-btn { display: inline-block; margin-top: 20px; color: #888; text-decoration: none; }
        
        /* Modal */
        .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 9999; }
        .modal-content { background-color: #111; color: white; border: 1px solid #444; padding: 30px; border-radius: 12px; width: 300px; text-align: center; }
    </style>
</head>
<body>
    
    <div class="header" style="background-color: #111; padding: 10px;">
        <nav class="navbar">
            <a href="index.html">TRANG CH·ª¶</a>
            <a href="history.html" class="active" style="color: #f39c12;">L·ªäCH S·ª¨</a>
            <a href="booking.html" class="highlight">ƒê·∫∂T L·ªäCH</a>
        </nav>
    </div>

    <div class="page-header">
        <h1>L·ªãch S·ª≠ ƒê·∫∑t B√†n</h1>
        <p>T√†i kho·∫£n: <b id="user-display-name">...</b></p>
    </div>

    <div class="container">
        <div class="table-responsive">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>#ID</th>
                        <th>Chi ti·∫øt</th>
                        <th>Th·ªùi Gian (B·∫Øt ƒë·∫ßu - K·∫øt th√∫c)</th>
                        <th>Ti·ªÅn & Thanh to√°n</th>
                        <th>Tr·∫°ng Th√°i</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr><td colspan="5" style="text-align:center; padding: 30px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        <a href="index.html" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Quay l·∫°i trang ch·ªß</a>
    </div>

    <footer id="footer" class="footer-design"></footer>

    <script>
        const API_URL = '/api';

        const userStr = localStorage.getItem('user_info') || localStorage.getItem('user');
        if (!userStr) window.location.href = 'login.html';
        const currentUser = JSON.parse(userStr);
        document.getElementById('user-display-name').innerText = currentUser.username || currentUser.full_name;

        // FORMAT
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        }
        function formatDateTimeVN(dateStr) {
            return new Date(dateStr).toLocaleString('vi-VN', {
                hour: '2-digit', minute: '2-digit',
                day: '2-digit', month: '2-digit', year: 'numeric',
                timeZone: 'Asia/Ho_Chi_Minh'
            });
        }

        fetch(`${API_URL}/history/${currentUser.id}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('history-body');
                tbody.innerHTML = ''; 
                if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 30px;">B·∫°n ch∆∞a ƒë·∫∑t b√†n n√†o.</td></tr>`; return; }

                data.forEach(item => {
                    let statusBadge = '';
                    // LOGIC TR·∫†NG TH√ÅI M·ªöI
                    if (item.status === 'confirmed') {
                        statusBadge = `<span class="status-badge st-confirmed">‚úÖ ƒê√£ ƒë·∫∑t</span>`;
                    } else if (item.status === 'pending') {
                        statusBadge = `<span class="status-badge st-pending">‚è≥ Ch·ªù thanh to√°n</span>`;
                    } else if (item.status === 'cancelled') {
                        statusBadge = `<span class="status-badge st-cancelled">‚ùå ƒê√£ h·ªßy</span>`;
                    } else {
                        statusBadge = `<span class="status-badge st-completed">üèÅ Ho√†n t·∫•t</span>`;
                    }

                    const pMethod = item.payment_method || 'Ti·ªÅn m·∫∑t';
                    const payTagHtml = pMethod.includes('Ti·ªÅn m·∫∑t') 
                        ? `<div class="pay-tag pay-cash">Ti·ªÅn m·∫∑t</div>` 
                        : `<div class="pay-tag pay-online">Chuy·ªÉn kho·∫£n</div>`;

                    tbody.innerHTML += `
                        <tr>
                            <td>#${item.id}</td>
                            <td>
                                <strong style="color:#facc15">${item.table_name || '?'}</strong><br>
                                <span style="font-size:12px; color:#888;">CN ${item.branch_id}</span>
                            </td>
                            <td>
                                <b>${formatDateTimeVN(item.start_time)}</b><br>
                                <span style="color:#aaa">ƒë·∫øn</span> <b>${formatDateTimeVN(item.end_time)}</b>
                            </td>
                            <td>
                                <b style="color:#4ade80">${formatMoney(item.total_price)}</b>
                                ${payTagHtml}
                            </td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
            });
    </script>
</body>
</html>